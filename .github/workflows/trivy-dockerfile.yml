name: Trivy Scan
on:
  workflow_dispatch:
jobs:
  trivy-IaC-scan:
    runs-on: ubuntu-latest
    steps:
      - shell: bash
        run: |
          wget https://github.com/aquasecurity/trivy/releases/download/v0.43.1/trivy_0.43.1_Linux-64bit.deb && sudo dpkg -i trivy_0.43.1_Linux-64bit.deb && sudo apt-get install expect-dev
      - name: Checkout code
        uses: actions/checkout@v3 
      - shell: bash
        run: |
          trivy config Dockerfile
          unbuffer trivy config Dockerfile | tee /tmp/reports/dockerfile_report_cis_devsecops.txt
      # - name: Run Trivy vulnerability scanner in IaC mode
      #   uses: aquasecurity/trivy-action@master
      #   with:
      #     scan-type: 'config'
      #     hide-progress: false
      #     format: 'sarif'
      #     output: 'trivy-results.sarif'
      #     exit-code: '1'
      #     ignore-unfixed: true
      #     severity: 'CRITICAL,HIGH'

      # - name: Upload Trivy scan results to GitHub Security tab
      #   uses: github/codeql-action/upload-sarif@v2
      #   with:
      #     sarif_file: 'trivy-results.sarif'
